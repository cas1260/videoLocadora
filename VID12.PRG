**********************************
*  VID12.PRG DEVOLUCAO DE FITAS  *
**********************************
SAVE SCREEN TO VTELA_DEV
DO WHILE .T.
	IF V_DEV = "N"
		NAO()
		EXIT
	ENDIF
	@ 04,00 CLEAR TO 23,78
	@ 04,00 TO 24,78 DOUBLE
	VCODIGO = SPACE(6)
	VLANC = 0
	VLANC = 0
	VCODPROD = SPACE(5)
	CENTRA(04,00,80,"[ Devoluá∆o de Fitas ]")
	SET KEY -1 TO E
	SET KEY -2 TO LOC
	@ 05,01 SAY "Codigo " GET VCODIGO PICT "999999"
	@ 05,20 SAY "[ F2 - PESQUISA DE CLIENTE  F3 - PESQUISA DE PRODUTO ]"
	READ
	SET KEY -1 TO
	SET KEY -2 TO
	IF LASTKEY()=27
		EXIT
	ENDIF
	IF VCODIGO <> SPAC(6)
		USE LOCACAO INDEX LOCACAOA INDEX LOCACAOB INDEX LOCACAOD
		VCODCLI = STRZERO(VAL(VCODIGO),6)
		SEEK VCODCLI
	ELSE

		@ 07,01 SAY "Lancamento " GET VLANC 
		READ
		IF LASTKEY() = 27
			EXIT
		ENDIF
		USE LOCACAO INDEX LOCACAOB INDEX LOCACAOA INDEX LOCACAOD
		SEEK VLANC
	ENDIF
	IF EOF()
		MSGBOX("Na∆o a Locacao em com este Cliente!")
		LOOP
	ELSE
		VPAGO = PAGO
		VENTREGUE = ENTREGUE
		IF VPAGO = "S" .AND. VENTREGUE = "S"
			MSGBOX("Na∆o a Locacao em com este Cliente!")
			LOOP
		ENDIF


		VNOMECLI = NOME
		VTOTAL = VALOR
		VDTLOC = DTLOC
		VDEVOLUCAO = DEVOLUCAO
		VCODCLI = CODIGO
		VNPROD = NPROD + 1
		VLANC = LANCA
		VTI = TI
		VALTERA=ALTERA
		VENTREGUE=ENTREGUE
		VPAGO=PAGO			
		VDEVOL=DEVOLUCAO
		VDTLOC=DTLOC
		VVALOR=VALOR
		VATRASO=DATE()-VDEVOL

		IF VTI = 0
			VNCLIENTE = "Titular"
		ELSEIF VTI = 1
			VNCLIENTE = "Dependete 1"
		ELSE
			VNCLIENTE = "Dependete 2"
		ENDIF
		PRIVATE VDESCRICAO[VNPROD],VVALOR[VNPROD],VCODPROD[VNPROD]
		USE LOCACAO2
		X = 1
		GO TOP
		@ 04,00 CLEAR TO 23,78
		@ 04,00 TO 24,78 DOUBLE

		@ 06,30 TO 23,74 DOUBLE
		@ 08,38 TO 22,38 DOUBLE
		@ 08,32 TO 08,73 DOUBLE
		@ 07,31 SAY "CODIGO ∫           DESCRICAO"
		@ 06,38 SAY "À"
		@ 08,38 SAY "Œ"
		@ 08,30 SAY "ÃÕ"
		@ 08,74 SAY "π"
		@ 23,38 SAY " "
		VLINHA=09
		X = 1
		DO WHILE !EOF()
			IF ALLTRIM(STR(VLANC)) = ALLTRIM(STR(LANCA))
				IF X<15
					VPRODUTO=PRODUTO
					@ VLINHA,32 SAY VPRODUTO
					VDESCRICAO=DESCRICAO
					@ VLINHA,40 SAY SUBS(VDESCRICAO,1,33)
					VLINHA=VLINHA+1
					X = X + 1
				ELSE
					@ 23,74 SAY CHR(25)
				ENDIF
			ENDIF
			SKIP
		ENDDO
*		@ 05,03 CLEAR TO 20,77
		@ 05,03 SAY "NOME......: "+VNOMECLI
		@ 06,03 SAY "CODIGO....: "+VCODCLI				
		@ 07,03 SAY "LOCACAO...: "
		@ 07,15 SAY	VDTLOC
		@ 08,03 SAY "DEVOLUCAO.: "
		@ 08,15 SAY VDEVOL				
		@ 09,03 SAY "LANCAMENTO: "+ALLTRIM(STR(VLANC))				
		VLIN=10
		VVATRASO=0
		IF VATRASO>0
			@ 10,03 SAY "ATRASO....: "
			@ 10,15 SAY ALLTRIM(STR(VATRASO))+" DIA(S)"
			@ 11,03 SAY "MULTA.....: "
			IF VSISTEMA = .T.
				@ 11,15 SAY VATRASO*VTOTAL PICTURE "@E 9,999.99"
				VLIN=12
				VVATRASO=VATRASO*VTOTAL
			ELSE
				IF VJUROS > 0
					VT = VTOTAL / 100 * VJUROS
				ELSE
					VT = 0
				ENDIF
					@ 11,15 SAY VATRASO*VT PICTURE "@E 9,999.99"
					VLIN=12
					VVATRASO=VATRASO*VT
			ENDIF
		ENDIF
		@ VLIN,03 SAY "VALOR.....: "
		@ VLIN,15 SAY VTOTAL PICTURE "@E 9,999.99"
		@ VLIN+1,03 SAY "TOTAL.....: "
		@ VLIN+1,15 SAY VTOTAL + VVATRASO PICTURE "@E 9,999.99"
		VVRPAGTO=VTOTAL+VVATRASO
		IF VPAGO#"S"
			@ 15,03 SAY "PAGO (S/N)....: " GET VPAGO PICTURE "!" VALID VPAGO$"SN"
			VPG=.F.
		ELSE
			@ 15,03 SAY "PAGO (S/N)....: SIM"
			VPG=.T.					
		ENDIF
		@ 16,03 SAY "ENTREGUE (S/N): " GET VENTREGUE PICTURE "!" VALID VENTREGUE$"SN"					
		READ
		IF LASTKEY()#27
			IF VPAGO="S" .AND. .NOT. VPG .AND. LASTKEY()#27
				DO PAGAMENTO
				IF LASTKEY()#27
					USE LOCACAO INDEX LOCACAOB INDEX LOCACAOA INDEX LOCACAOD
					SEEK VLANC
					REPLACE TPPAGTO WITH VTP DTPAGO WITH VDATA VALORPAGO WITH VR ENTREGUE WITH VENTREGUE PAGO WITH "S"
				ENDIF
			ENDIF
			IF VENTREGUE="S" .AND. VPAGO="S" .AND. LASTKEY()#27
				USE LOCACAO INDEX LOCACAOB INDEX LOCACAOA INDEX LOCACAOD
				SEEK VLANC
				VR=VALORPAGO
				VTP=TPPAGTO
				IF VPG
					VDATA=DTPAGO
				ENDIF		
				DELE 
				PACK
				REINDEX
				USE LOCATOT
				APPE BLANK
				REPLACE CODCLI WITH VCODCLI 
				REPLACE DTLOC WITH VDTLOC
				REPLACE DEVOLUCAO WITH VDEVOL 
				REPLACE DTPAGO WITH VDATA
				REPLACE VALOR WITH VTOTAL+VVATRASO 
				REPLACE VALORPAGO WITH VR
				REPLACE LANCAMENTO WITH VLANC
				REPLACE ALTERA WITH VALTERA 
				REPLACE TPPAGTO WITH VTP
			ENDIF
		ENDIF
	ENDIF
ENDDO
RESTORE SCREEN FROM VTELA_DEV
RETURN

*******************
PROCEDURE PAGAMENTO
*******************
PUBLIC VTP,VR,VTP,VDATA
VDATA=DATE()
VTP=SPACE(1)
VR=VVRPAGTO
VOBS=SPACE(50)
@ 12,10 CLEAR TO 18,77 
@ 12,10 TO 18,77 DOUBLE
VTP = "1"
*@ 11,12 SAY "TIPO DE PAGTO..: " GET VTP PICTURE "9" VALID VTP$"123" 
*@ 11,33 SAY "(1)Dinheiro (2)Cheque (3)Cartao "
@ 13,12 SAY "DATA PAGAMENTO.: " 
@ 13,29 SAY VDATA
TOTAL=VR
@ 15,12 SAY "VALOR A PAGAR..: " GET VR PICTURE "999,999.99"
READ
IF TOTAL>VR
* VR<VVRPAGTO
	@ 17,12 SAY "EXPLICACAO: " GET VOBS PICTURE "@!"
	READ
	IF LASTKEY()#27
		USE EXPLICA
		APPEND BLANK
		REPLACE CODCLI WITH VCODCLI NOME WITH VNOMECLI DATA WITH DATE()
		REPLACE LANCAMENTO WITH VLANC EXPLICACAO WITH VOBS
		REPLACE VALOR WITH VR VALORT WITH TOTAL
		REPLACE NOME_U WITH VNOME_U
	ENDIF
ENDIF
*RETURN
	
