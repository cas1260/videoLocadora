**************************************
*		 VID11.PRG LOCACAO DE FITAS	 *
**************************************
PUBLIC VLANC_A
SAVE SCREEN TO VTELA_LOC
DO WHILE .T.
	IF VLOCACAO = "N"
		NAO()
		EXIT
	ENDIF
	USE CONTA
	VLANCA = CLEBER + 1
	VLANC_A = CLEBER + 1
	USE TEMP
	DO WHILE !EOF()
		DELE
		SKIP
	ENDDO
	PACK
	CLOSE ALL
	VCODIGO = SPACE(6)
	SET KEY -1 TO E
	@ 04,00 CLEAR TO 23,78
	@ 04,00 TO 24,78 DOUBLE
	CENTRA(04,01,77,"[ Loca‡Æo de Fitas ]")
	@ 05,02 SAY "Codigo do Cliente " GET VCODIGO PICT "999999"
	@ 05,33 SAY "[ F2 PESQUISA DE CLIENTE ]"
	READ
	IF LASTKEY() = 27
		EXIT
	ENDIF
	IF VCODIGO = SPACE(6)
		VCODIGO =  E()
	ENDIF
	VCODIGO = STRZERO(VAL(VCODIGO),6)
	@ 05,02 SAY "Codigo do Cliente  " + VCODIGO
	SET KEY -1 TO
	USE CLIENTE INDEX CLIENTEA INDEX CLIENTEB

	SEEK VCODIGO
	IF EOF()
		MSGBOX("Cliente nao Encotrado!")
	ELSE
		VPROB = PROBLEMA
		VOBS = OBSERVACAO
		VNOMECLI = ALLTRIM(NOME)
		IF VPROB = "S"
			SAVE SCREEN TO VTELA_OBS
				CENTRA(09,10,65,"[ Obs do Cliente ]")
				@ 10,10 CLEAR TO 20,65
				@ 10,10 TO 20,65 DOUBLE
				CENTRA(10,10,65,"[ " + VNOMECLI + " ]")
				VTESTE = MEMOEDIT(VOBS,11,11,19,64,.F.)
				VSIMNAO = SIMNAO(15,35,"Deseja Continuar ?",.T.) 
				IF VSIMNAO = 2 .OR. VSIMNAO = 0
					EXIT				
				ELSE
				ENDIF
			RESTORE SCREEN FROM VTELA_OBS
		ENDIF

		@ 07,05 TO 12,46 DOUBLE
		@ 09,06 TO 09,45 DOUBLE
		CENTRA(07,05,46,"[ Titular ]")
		CENTRA(09,05,46,"[ Dependentes ]")
		@ 08,06 PROMPT NOME
		@ 10,06 PROMPT DEP1
		@ 11,06 PROMPT DEP2
		MENU TO VOPCAO
		DO CASE
			CASE VOPCAO = 0
				LOOP
			CASE VOPCAO = 1
				VNCLIENTE = "Titular"
				VNOMECLI = NOME
				VTI = 0 
			CASE VOPCAO = 2
				VNCLIENTE = "Dependete 1"
				VNOMECLI = DEP1
				VTI = 1
			CASE VOPCAO = 3
				VNCLIENTE = "Dependete 2"
				VNOMECLI = DEP2
				VTI = 2
		ENDCASE
		VENDERECO = ENDERECO
		VCODCLI = VCODIGO
		VTOTAL = TELA(.T.)
		VCODIGO = SPACE(5)
		DO WHILE .T.
			VCODIGO = SPACE(5)
			VTOTAL = TELA(.T.)
			@ 23,16 SAY "[ F2 - PESQUISA ]"
			@ 23,35 SAY "Finalizar"
			@ 23,50 SAY "Excluir"
			SET KEY -1 TO SHOW
			@ 23,01 say "Codigo " GET VCODIGO PICT "99999"
			READ
			SET KEY -1 TO
			IF LASTKEY() = 27
				EXIT
			ENDIF
			IF VCODIGO = SPACE(5)
				@ 23,35 PROMPT "Finalizar"
				@ 23,50 PROMPT "Excluir"
				MENU TO EX
				DO CASE 		
					CASE EX = 1
						VX = FINAL()
						IF VX = .T.
							IF LASTKEY() # 27
								DO PRINT_P							
								EXIT	
							ENDIF
						ELSE
							LOOP
						ENDIF
					CASE EX = 2
						USE TEMP
						IF EOF()
							MSGBOX("NÆo a Iten a Ser excluido!")
							LOOP
						ENDIF
						IF LASTKEY()#27
							TELA(.F.)
						ENDIF
						LOOP
				ENDCASE
			ENDIF
			VCODIGO = STRZERO(VAL(VCODIGO),5)
			USE LOCACAO2 INDEX LOCACAOC
			SEEK VCODIGO
			IF !EOF()
				DO WHILE VCODIGO = PRODUTO
					IF VCODIGO = PRODUTO .AND. VCODCLI = CLIENTE
						MSGBOX("O Cliente J  Locou Esta Fita !")
						EXIT
					ENDIF
					SKIP
				ENDDO
				IF LASTKEY() = 27
					LOOP
				ENDIF
			ENDIF
			USE PRODUTO INDEX PRODUTOA INDEX PRODUTOB
			SEEK VCODIGO
			IF EOF()
				MSGBOX("Produto nao Encotrado!")
			ELSE
				VNOMEPROD = DESCRICAO
				VCODTIPO = STRZERO(VAL(TIPO),2)
				VCODPROD = CODPROD
				VVALORTIPO = 0
				USE TIPO INDEX TIPOA
				SEEK VCODTIPO
				IF EOF()
					VVALORTIPO = 0
				ELSE
					VVALORTIPO = VALORTIPO
				ENDIF
				USE TEMP
				APPEND BLANK
					REPLACE DESCRICAO WITH VNOMEPROD
					REPLACE VALOR WITH VVALORTIPO
					REPLACE CODPROD WITH VCODPROD
				VTOTAL = TELA(.T.)
				
			ENDIF	
		ENDDO
	ENDIF
ENDDO
RESTORE SCREEN FROM VTELA_LOC
RETURN
**************
FUNCTION TELA
**************
PARAMETERS VTYPE
@ 05,01 CLEAR TO 23,77
PRIVATE VCAMPOS[3],VCAB[3]
IF VTYPE = .T.
	KEYBOARD CHR(13)
ENDIF
USE TEMP

VCAMPOS[1] = "DESCRICAO"
VCAMPOS[2] = "CODPROD"
VCAMPOS[3] = "VALOR"

VCAB[1] = "Descricao"
VCAB[2] = "Codigo" 
VCAB[3] = "Valor"
	
@ 04,00 TO 19,58 DOUBLE
@ 19,00 TO 19,78 DOUBLE
@ 19,58 SAY "Ê"
@ 19,78 SAY "¹"
@ 04,58 SAY "Ë"
@ 19,00 SAY "Ì"
@ 21,00 SAY "Ì"
@ 21,78 SAY "¹"
@ 21,01 TO 21,77 DOUBLE
USE LOCACAO
VMSG_GG = "[ "+ VNCLIENTE +" : " + ALLTRIM(VNOMECLI) + " Codigo "+ VCODCLI + " Lanc. " + ALLTRIM(STR(VLANC_A))+" ]"
CENTRA(20,01,77,VMSG_GG)
VTOTAL = 0
USE TEMP
DO WHILE !EOF()
	VTOTAL = VTOTAL + VALOR
	SKIP
ENDDO
@ 10,60 CLEAR TO 12,77
@ 10,60 TO 12,77 DOUBLE
CENTRA(10,60,77,"[ TOTAL ]")
@ 11,61 SAY "R$ "
@ 11,64 SAY VTOTAL

@ 14,60 CLEAR TO 16,77
@ 14,60 TO 16,77 DOUBLE
CENTRA(14,60,77,"[ Devolucao ]")
VDATA_DEV = DATE()+LASTREC()
@ 15,64 SAY VDATA_DEV
GO TOP
DBEDIT(05,01,18,57,VCAMPOS,0,0,VCAB)

IF VTYPE = .F.
	IF LASTKEY()#27
		@ 12,40 CLEAR TO 15,65
		@ 12,40 TO 15,65 DOUBLE
		CENTRA(13,40,65,"Deseja Excluir?")
		@ 14,45 PROMPT " SIM "
		@ 14,53 PROMPT " NAO "
		MENU TO VOP
		DO CASE 
			CASE VOP=1
				DELE
			ENDCASE
		KEYBOARD CHR(1)
	ENDIF
ENDIF
RETURN VTOTAL
***************
FUNCTION FINAL
***************
SAVE SCREEN TO VTELA_FINAL
	SAVE SCREEN TO VTELA_FIM
	@ 12,40 CLEAR TO 15,65
	@ 12,40 TO 15,65 DOUBLE
	CENTRA(13,40,65,"Confimar loca‡Æo?")
	@ 14,45 PROMPT " SIM "
	@ 14,53 PROMPT " NAO "
	MENU TO VOP
	RESTORE SCREEN FROM VTELA_FIM
	DO CASE 
		CASE VOP=1
		VALTERA = "N"
		@ 17,61 SAY "ALTERA DADOS"
		@ 18,61 SAY "FINAIS (S/N)" GET VALTERA PICTURE "!" VALID VALTERA$"SN"
		READ
		VRE = .T.
		IF VALTERA = "S"
			@ 11,67 GET VTOTAL PICT "999,999.99"
			@ 15,64 GET VDATA_DEV			
			READ
		ENDIF
		IF LASTKEY() = 27
			VRE = .F.
		ELSE
			DO FINAL_GRAVA
		ENDIF
		CASE VOP = 2
			VRE = .F.
	ENDCASE
RESTORE SCREEN FROM VTELA_FINAL
RETURN VRE
*********************
PROCEDURE FINAL_GRAVA
*********************
USE TEMP
PRIVATE VDESCRICAO[LASTREC()+1],VCODPROD[LASTREC()+1],VVALOR[LASTREC()+1]
USE TEMP
VNPROD = LASTREC() + 1 
GO TOP
X = 1
DO WHILE !EOF()
	VDESCRICAO[X] = DESCRICAO
	VVALOR[X] = VALOR
	VCODPROD[X] = CODPROD
	SKIP
	X = X + 1
ENDDO
USE LOCACAO2 INDEX LOCACAOC
P = 1

DO WHILE P<>X
	APPEND BLANK
	REPLACE PRODUTO WITH VCODPROD[P]
	REPLACE CLIENTE WITH VCODCLI
	REPLACE VALOR WITH VVALOR[P]
	REPLACE DESCRICAO WITH VDESCRICAO[P]
	REPLACE LANCA WITH VLANCA
	REPLACE NOMECLI WITH VNOMECLI
	P = P + 1
ENDDO
USE LOCACAO INDEX LOCACAOA INDEX LOCACAOB INDEX LOCACAOD
APPEND BLANK
	REPLACE CODCLI WITH VCODCLI
	REPLACE DTLOC WITH DATE()
	REPLACE NOME WITH VNOMECLI
	REPLACE LANCA WITH VLANCA
	REPLACE VALOR WITH VTOTAL
	REPLACE CODIGO WITH VCODCLI
	REPLACE DEVOLUCAO WITH VDATA_DEV
	REPLACE NPROD WITH VNPROD
	REPLACE TI WITH VTI
USE CONTA
REPLACE CLEBER WITH VLANC_A
*******************
PROCEDURE PRINT_P							
******************
DO T_PRINT
*SET PRINTER TO VIDEO
SET DEVICE TO PRINT
IF LASTKEY()#27
	CENTRA(00,00,60,VCABE1)
	CENTRA(01,00,60,VCABE2)
	CENTRA(02,00,60,VCABE2)
	@ 03,01 SAY "RECIBO CLIENTE "
	@ 03,30 SAY DATE()
	@ 03,45 SAY TIME()
	@ 04,01 SAY REPLICATE("=",60)
	@ 05,01 SAY "NOME......: "+SUBS(VNOMECLI,1,30)+"   COD.: "+VCODCLI
	@ 06,01 SAY "ENDERECO..: "+VENDERECO
	@ 07,01 SAY "LANCAMENTO: "+LTRIM(STR(VLANC_A))
	@ 08,01 SAY CHR(14)+"T I T U L O (S) "+CHR(20)+"           PRODUTO       VALOR"
	@ 09,01 SAY REPLICATE("-",60)
	X=1	
	Y=10
	USE TEMP
	DO WHILE !EOF()
		@ Y,01 SAY SUBS(DESCRICAO,1,30)
		@ Y,36 SAY CODPROD
		@ Y,43 SAY VALOR PICTURE "99,999.99"
		Y=Y+1
		SKIP
	ENDDO
	@ Y,01 SAY REPLICATE("-",60)
	Y=Y+2
	@ Y,01 SAY "# # # # VALOR TOTAL..... R$ "
	VRTOT = VTOTAL
	@ Y,30 SAY VRTOT PICTURE "99,999.99"
	Y=Y+2
	@ Y,1   SAY "# # # # DEVOLUCAO.......: "
	VDATA = VDATA_DEV
	@ Y,30 SAY VDATA
	Y=Y+3
	@ Y,01 SAY "CLIENTE:_____________________________________"
	Y=Y+2
	@ Y,01 SAY "ATENDENTE: " + VNOME_U
	Y=Y+2
	CENTRA(Y,00,60,VRODA1)
	Y=Y+1
	CENTRA(Y,00,60,VRODA2)
	Y=Y+1
	CENTRA(Y,00,60,VRODA3)
	@ Y+33,00 SAY ""
ENDIF
SET DEVICE TO SCREEN